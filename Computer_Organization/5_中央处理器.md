# 中央处理器

## CPU的功能和基本结构

### CPU的功能

1. 指令控制
2. 操作控制
3. 时间控制
4. 数据加工
5. 中断处理

### CPU的基本结构

- 运算器
  - 算术逻辑单元
  - 通用寄存器组
    - AX、BX、CX、DX、SP
  - 暂存寄存器
    - ![](C:\Users\14485\Desktop\图片1.png)
  - 累加寄存器
  - 程序状态寄存器
  - 移位器
  - 计数器
  
- 控制器
  - 程序计数器:
    - 用于指出下一条指令在主存中的存放地址.CPU就是根据PC的内容去主存中取指令的.因程序中指令(通常)是顺序执行的,所以PC有自增功能
  - 指令寄存器:
    - 用于保存当前正在执行的那条指令.
  - 指令译码器:
    - 仅对操作码字段进行译码,向控制器提供特定的操作信号
  - 微操作信号发生器:
    - 根据IR的内容(指令)、PSW的内容(状态信息)及时序信号,产生控制整个计算机系统所需的各种控制信号,其结构有组合逻辑型和存储逻辑型两种
  - 时序系统:
    - 用于产生各种时序信号,它们都是由统一时钟(CLOCK)分频得到.
  - 存储器地址寄存器:
    - 用于存放所要访问的主存单元的地址
  - 存储器数据寄存器:
    - 用于存放向主存写入的信息或从主存中读出的信息.
---------
## 指令的执行过程
- 指令周期
  - CPU从主存取出并执行指令的全部时间
    - 取指周期：
      - 根据PC中的内容取出指令代码并存放在IR中
    - 间址周期：
      - 更具IR中的指令地址码取出操作数的有效地址
    - 执行周期：
      - 更加指令字的操作码和操作数进行相行相应的操作
    - 中断周期：
      - 保存断点，送中断向量，处理中断请求
- 指令周期的数据流
  
- 指令执行方案
  - 单指令周期
  - 多指令周期
  - 流水线方案

------
## 数据通路的功能和基本结构
- 数据通路的功能
  - 实现CPU内部的运算器和寄存器间的数据交换
- 数据通路的基本功能
  - 基本结构分类
    - CPU内部单总线方式
      - 将所有寄存器的输入输出连接在同一条数据通路上
    - CPU内部三总线方式 
      - 将所有寄存器的输入输出连接在同多条数据通路上
    - 专用数据通路方式
      - 减少共享路线，专线专用
  - 数据传输    
    - 寄存器之间的数据传输
    - 主存与CPU之间的数据传输
    - 执行算术和逻辑运算 

---------
## 控制器的功能和工作原理
### 控制器的结构
- 结构
  -  运算器部件通过**数据总线**与内存储器、输入设备和输出设备传送数据
  -  输入设备和输出设备通过**接口电路**与总线相连接
  -  内存储器、输入设备和输出设备从地址总线接收地址信息,控制总线得控制信号,数据总线与其他部件传送数据
- 功能
  - 主存中取出指令,产生下一条指令在主存中的地址
  - 对指令进行译码或者测试,产生相应的操作控制信号,以便启动规定的动作
  - 指挥并控制CPU、主存、输入和输出设备之间的数据流动方向
### 硬部线控制器:
- >根据指令要求、当前的时序以及外部和内部的状态,按照时间的顺序发送一些微操作控制信号又称为组合逻辑控制器
- 控制单元（CU）的信号来源 
  1. 指令译码器的信息 
  2. 时序系统产生的周期信号和节拍信号 
  3. 来自执行单元的反馈标识 
- 硬布线控制器的时序系统及微操作
  - 时钟周期：
    - 用时钟信号控制节拍拍发生器
  - 机器周期：
  - 指令周期:  
- CPU的控制方式
  - 同步控制
  - 异步控制
  - 联合控制
- 硬部件控制设计
### 微程序控制器
- 基本概念
  - >采用存储逻辑实现,将微操作信号代码化,控制存储器存储微程序,微操作控制信号由微指令产生
  - 微指令和微操作
    - 操作控制字段
    - 顺序控制字段
  - 程序和微程序
    - 程序：  指令的有限集合
    - 微程序：  微命令的有限集合
  - 微地址寄存器CMAR
    - 用于存放控制存储器（读/写）微指令的地址
  - 微指令寄存器CMDR
    - 用于存放从控制存储器中读出的微指令  
- 微程序控制器的组成和工作过程
  - 基本组成
    - 控制存储器: 存放指令对应的微程序,ROM构成
    - 微指令寄存器: 存放微指令
    - 微地址形成部件: 产生初始微地址和后继微地址
    - 微地址寄存器: 接收微地址
  - 工作过程
    
    1. 取微指令： 微程序入口自动送入CMAR； CM中读入微指令CMDR
    2. 机器指令操作码字段通过微地址形成部件产生微程序的入口地址,并将其送入CMAR
    3. 从CM中逐条取出对应的微指令并执行
    4. 执行完后,继续从头循环往复
  - 微指令编码方式
    - 直接编码法
    - 字段直接编码法
    - 字段间接编码法
  - 微指令地址形成方式
    - 直接由微指令的下地址字段给出
    - 根据机器指令的操作码形成
  - 微指令格式
    1. 水平型微指令
    2. 垂直型微指令
    3. 混合型指令
  - 动态微程序设计和毫微程序设计
    - 动态微程序设计
      - 根据用户要求改变微程序、采用EPROM
    - 毫微程序设计
      - 主存的每条指令都是放在控制存储器中的微程序解释执行的,通过控制线对硬件进行直接控制
-------
## 指令流水线
### 流水线的基本概念
- 概念:把一个重复的过程分解成若干个子过程,每个子过程可以与其他子过程并行执行
- 优点:只需要增加少量的硬件就能把计算机的运算速度提高几倍
- 指令流水的定义
  - 一条指令的执行可以分为多个阶段
    1. 取指:根据PC从主存中取出指令送入IR
    2. 分析:对指令操作码进行译码,按照寻址方式和地址段内容形成有效地址EA,并从有效地址中取出操作数
    3. 执行:根据操作码字段,完成指令规定功能,将运算结果写到通用寄存器或者主存中
- 多条指令的处理方式
  - 顺序执行方式    
    -  一条接一条指令执行,传统冯诺依曼机顺序执行方式 $T=3nt$
    - 优点:控制简单,硬件代价小
    - 缺点:执行指令速度慢,各功能部件的利用率很低
  - 一次重叠执行方式
  - 二次重叠执行方式
- 流水线的表示方式
  - 顺序执行方式
  - 一次重叠执行方式
  - 二次重叠执行方式
- 流水线的特点
  - 一个任务分解成多个子任务
  - 每个功能部件后面都要有个锁存器,用于保存本流水段的结果
  - 流水线中的各功能段的时间应尽量相等,否则将会堵塞、断流
  - 流水线需要装入时间和排空时间
    - 装入时间: 第一个任务进入流水线到输出流水线的时间
    - 排空时间: 最后一个任务进入流水线到输出流水线的时间
### 流水线的分类
- 按照流水级别分类
    1. 部件功能级流水线:将复杂的算术逻辑运算组成流水线的工作方式
    2. 处理机级流水线:一条指令解释成多个子过程
    3. 处理机间流水线:是一种宏流水,每个处理机专门完成一个任务,各个处理机得到的结果存放在与下一个处理机共享的存储器中
- 按照功能分类
  - 单功能流水线:
    - 完成单一功能
  - 多功能流水线:
    - 各个流水段之间通过组合可以实现多种功能
- 按照连接方式分类
  - 静态流水线:
    - 同一时间内,流水线的各段只能按照同一种功能的连接方式工- 
  - 动态流水线:
    - 不同的段完成的运算可能不一样,可以提高效率,但是流水线控制变得很复杂
- 按照是否存在反馈信号分类
  - 线性流水线:
    - 不存在反馈回路
  - 非线性流水线:
    - 存在反馈回路,非常适合线性递归运算
### 影响流水线的因素
- 结构相关(资源冲突)
  - 概念:同一时刻争抢统一资源
  - 解决方法
    - 冲突指令之间,插入暂停周期
    - 单独设置数据存储器和指令存储器,但是增加了资源消耗
- 数据相关(数据冲突)
  - 概念:一个指令的执行必须要等待前一个指令的结果
- 控制相关(控制冲突)
  - 概念:出现转移指令或者其他改变PC值得指令造成断流
  - 解决方法
    - 对转移指令进行分支预测
    - 预取转移成功和不成功两个控制流方向上的目标指令
    - 加快和提前形成条件码
    - 提高转移方向的猜准率
### 流水线的性能指标
- 吞吐率
  - 单位时间内流水线完成的任务数量
  - $T=n/Tk$  n是任务数,Tk是处理完n个任务的时间
- 流水线的加速比
  - $S=T_0/T_k$
- 流水线效率
  - $E=T_0/kT_k$
### 超量流水线的基本概念
- 超标量流水线技术
  - 每个时钟周期内可以并发多条独立指令
  - 可以编译优化,把可并行执行的指令搭配起来,挖掘指令并行性
- 超流水线技术
  - 在一个时钟周期内再分段,在一个时钟周期内一个功能部件使用多次
  - 编译程序解决优化问题
- 超长指令字
  - 使用多个功能部件,利用编译程序挖掘出指令之间的并行性,然后将并行指令组成超长指令
